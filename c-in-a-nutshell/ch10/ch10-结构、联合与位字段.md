# 结构、联合与位字段

## 结构

基本声明语法如下：

```
struct [name] { struct-declaration-list }
```

其中 `name` 是该结构的标签(Tag)

1. 结构类型无法将自己的类型作为其成员的类型，但是可以声明指向自己类型的指针。

### 结构与 typedef

因为 C 语言中 `struct <name>` 合在一起才是一个完整的自定义类型。
所以 C 语言中的类型类型需要写成 `struct <name> varName;` 这样的形式。
为了简化 `struct <name>` 的使用，一般会使用`typedef` 来重定义。
`typedef struct <name> <ShortStructTypeName>`
或者干脆在定义时省略掉`struct` 的标签名。这样定义。
`typedef struct { struct-declration-list } ShortStructTypeName`

### 空结构声明的使用

比如如下的互相引用的结构中

```c
struct A{ struct B *pB;};
struct B{ struct A *pA;};
```

为了确保 `struct A` 里面的 `struct B` 引用的后面声明的 B。
而不是之前的更作用域中的 `struct B` 可以在 `struct A` 的前面声明一个空的 `struct B`
来屏蔽来自其他作用域的影响。如下：

```c
struct B;
struct A{ struct B *pB;};
struct B{ struct A *pA;};
```

### 获取结构成员

1. `.` 运算符用于获取结构对象成员。
2. `->` 运算符用于获取结构指针对象成员。

\*(p).fieldName 相当于 `p->fieldName`

### 结构对象是值对象

也就是说一个将一个结构对象变量赋值给另一个结构对象变量时，会将整个结构的对象内容复制到另一个同类型的对象中：（与 Swift 中的 struct 值对象的概念相同）
因此较大的结构对象的传参通常使用传地址的方式。

### 初始化特定成员

C99 允许 结构初始化时也可以指定对应的字段名称。通过成员指示符来实现(member designator)
例如:

```c
Singer chou = {.name = "周杰伦",.gender = 'm'};
```

### 内存中的结构成员

在结构定义时声明的各成员的顺序，就是对应的结构对象成员在内存中的存储有顺序。第一个成员的地址就是结构对象本身的地址，声明的有顺序越往后，地址越大。

可以通过宏 `offsetof` 来获取 成员地址与结构对象的起始地址之间的偏差。
编译器可能会在结构的最后一个成员后面补充额外的字节，该过程通常称之为(padding),所以无论何时都应该使用 `sizeof` 来得到结构空间的大小。

有时为了与硬件接口一致也可以人为地控制编译器对结构成员的对齐方式（例如避免成员之间的内存间隙）

## 联合

联合的定义方式跟结构是一样的的。只是把关键字由`struct` 变成了 `union`
因此一些共性的东西可以参考结构的定义的相关语法。
联合相当于一个可变类型变量，联合声明的各个字段是其各个可能的类型， 联合的空间大小为其最大成员的空间大小。

## 匿名结构与联合

匿名结构与联合是 C11 中的新的特性，它允许定义结构和联合类型时具有更大的灵活性。如果一个结构或者联合在定义时未命名结构成员或者未指定标签名称，则称为匿名结构或联合。
例如计算机术语中一个字节是 8 位，一个字是 16 位。一个字的前 8 位称之为低字节，后 8 位可以称之为高字节。
那么这个字的内存表示我们可以通过如下联合定义来表示。

```c
union Word
{
  int16_t word;
  struct { int8_t low,high;}; //匿名结构 ， 因为一般是小端序，所以低字节在前
};
```

```c
union Word
{
  int16_t word;
  struct { int8_t low,high;}; //因为一般是小端序，所以低字节在前
};

union Doubleword{
  int32_t double_word;
  struct{
    union Word low;
    union Word high;
  };
};
```

## 位字段

结构或者联合的成员也可以是位字段。
位字段(bit-field) 是一个由具有特定数量的位组成的整数变量，如果连续声明多个小的位字段，编译器会将它们合并成一个机器字组成的整型变量，这使得小单元信息具有更加紧凑的存储方式。

位字段的声明格式如下：

```js
类型[成员名称]:宽度;
```

其中类型只能是以下 4 种：
`unsigned int, signed int, int, _Bool`
并且其值不能大于指定的位宽度。
对于匿名位字段用于填充(padding), 以帮助后续的位字段在机器字中对齐到特定的地址边界。
如果紧接着的位字段不适合同一内存单元的剩余空间，那么编译器就会分配另外的内存单元。
